<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>足関節内反捻挫 評価アプリ</title>
  <style>
    :root { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; }
    body { margin: 0; padding: 0; background-color: #f5f7fa; }
    
    /* ヘッダースタイル */
    .header {
      background: linear-gradient(135deg, #6a75eb 0%, #9066cc 100%);
      color: white;
      padding: 1.5rem;
      text-align: center;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }
    
    .header h1 {
      font-size: 1.8rem;
      margin: 0;
      font-weight: 600;
      line-height: 1.3;
    }
    
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 0.5rem;
    }
    
    /* コンテンツコンテナ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    /* タブナビゲーション */
    .tabs-container {
      margin-bottom: 1.5rem;
      overflow-y: auto; /* 縦スクロール可能にする */
      -webkit-overflow-scrolling: touch; /* iOSのスムーズスクロール */
    }
    .tabs {
      display: flex;
      flex-direction: column; /* 縦方向に変更 */
      border-left: 1px solid #ddd;
      margin-bottom: 1rem;
      width: 100%;
    }
    .tab {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border: 1px solid #ddd;
      border-left: 3px solid transparent;
      margin-bottom: 0.25rem; /* 下余白で間隔を取る */
      background-color: #f8f9fa;
      transition: all 0.2s ease;
    }
    .tab:hover {
      background-color: #e9ecef;
      border-left: 3px solid #9066cc;
    }
    .tab.active {
      border: 1px solid #ddd;
      border-left: 3px solid #6a75eb;
      background-color: white;
      font-weight: bold;
    }
    
    /* スマートフォン向け最適化 */
    @media (max-width: 768px) {
      .tab {
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .container {
        padding: 0.75rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.3rem;
      }
    }
    
    /* タブコンテンツ */
    .tab-content {
      display: none;
      padding: 1.5rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: 1.5rem;
    }
    
    .tab-content.active {
      display: block;
    }
    label { display: block; margin: .5rem 0; }
    input[type="number"], input[type="text"] { width: 100%; padding: .4rem; }
    .radio-group { display: flex; gap: .75rem; flex-wrap: wrap; }
    .tag { padding: .2rem .5rem; border-radius: .3rem; font-size: .8rem; }
    .tag.Hypomobile  { background:#ffdad6; }
    .tag.Inflexible  { background:#ffe5c0; }
    /* .tag.Normal      { background:#e0ffd6; } */
    /* 背屈可動域が正常範囲内 (6  15 ) */
    .tag.Normal      { background:#e0ffd6; }
    .tag.Flexible    { background:#d6f0ff; }
    .tag.Hypermobile { background:#e0d6ff; }
    button { padding: .6rem 1.2rem; font-size: 1rem; margin-top: 1rem; }
    .classification-table { margin-top: 1rem; padding: 1rem; border: 1px solid #e0e0e0; border-radius: .5rem; }
.classification-item { margin-bottom: .5rem; }
.reference-image { max-width: 100%; height: auto; margin-top: 1rem; border: 1px solid #e0e0e0; }
.image-container { position: relative; margin-bottom: 1rem; }
.image-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
.tool-btn { padding: .4rem .8rem; margin-right: .5rem; cursor: pointer; border-radius: .3rem; }
.tool-btn.selected { background: #007bff; color: white; }
.color-option { width: 20px; height: 20px; display: inline-block; margin-right: .5rem; border-radius: 50%; cursor: pointer; }
.color-option.selected { border: 2px solid black; }
.mark-controls { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; }
    
    /* 競技復帰評価関連スタイル */
    .btn-small {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
    
    .btn-small:hover {
      background-color: #5a6268;
    }
    
    .subsection {
      margin-bottom: 1.5rem;
      padding: 0.75rem;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    
    .subsection h4 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      color: #495057;
    }
    
    .slider-container {
      margin-bottom: 1rem;
    }
    
    .slider-container p {
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    
    .slider {
      width: 100%;
      margin: 10px 0;
    }
    
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #6c757d;
    }
    
    .slider-value {
      text-align: center;
      font-weight: 600;
      color: #007bff;
      margin-top: 0.25rem;
    }
    
    .faam-item {
      margin-bottom: 0.75rem;
    }
    
    .faam-item p {
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    
    .faam-item select {
      width: 100%;
      padding: 0.25rem;
      border: 1px solid #ced4da;
      border-radius: 3px;
    }
    
    .score-item {
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .recommendation {
      padding: 0.5rem;
      border-radius: 5px;
      margin-top: 0.5rem;
      font-weight: 500;
    }
    
    .recommendation.good {
      background-color: #d4edda;
      color: #155724;
    }
    
    .recommendation.caution {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .recommendation.bad {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>

  <!-- グラデーションヘッダー -->
  <div class="header">
    <h1>足関節内反捻挫<br>評価アプリ</h1>
  </div>

  <div class="container">
    <!-- タブナビゲーション -->
    <div class="tabs-container">
      <div class="tabs">
        <div class="tab active" data-tab="field">現場評価</div>
        <div class="tab" data-tab="acute">急性期</div>
        <div class="tab" data-tab="subacute_recovery">亜急性期・回復期</div>
        <div class="tab" data-tab="return">スポーツ復帰評価</div>
        <div class="tab" data-tab="competition">競技復帰評価</div>
        <div class="tab" data-tab="history">データ履歴</div>
      </div>
    </div>

    <form id="evalForm">
      <!-- 0. 現場評価 (On‑field / Sideline) -->
      <div class="tab-content active" data-tab="field">
        <h2>Ottawa Ankle Rules</h2>
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <div style="display: flex; flex-direction: column; gap: .5rem;">
          <label><input type="checkbox" name="ottawa_lateral_malleolus" /> 腓骨遠位・外果の痛み（圧痛を含む）</label>
          <label><input type="checkbox" name="ottawa_medial_malleolus" /> 脛骨遠位・内果の痛み（圧痛を含む）</label>
          <label><input type="checkbox" name="ottawa_walk4" /> 受傷直後4歩以上歩けない</label>
          <label><input type="checkbox" name="ottawa_navicular" /> 舟状骨の圧痛</label>
          <label><input type="checkbox" name="ottawa_5thmeta" /> 第5中足骨の圧痛</label>
          <p id="ottawaResult"></p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <h3>解説</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
            <!-- 画像1とマーキングキャンバス -->
            <div class="image-container" style="width: 45%; min-width: 250px; max-width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; padding: 10px; background: white; margin: 0 auto;">
              <img src="/3.png" alt="Ottawa Ankle Rules 1" style="width: 100%; display: block; border-radius: 5px;">
              <canvas id="markCanvas1" class="image-canvas"></canvas>
              <p style="text-align: center; font-weight: bold; margin-top: 0.5rem;">内側</p>
              <p style="text-align: center; color: #666; font-size: 0.85rem;"><i class="fas fa-pencil-alt"></i> ここをタップ/クリックしてマーキングできます</p>
            </div>
            <!-- 画像2とマーキングキャンバス -->
            <div class="image-container" style="width: 45%; min-width: 250px; max-width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; padding: 10px; background: white; margin: 0 auto;">
              <img src="/4.png" alt="Ottawa Ankle Rules 2" style="width: 100%; display: block; border-radius: 5px;">
              <canvas id="markCanvas2" class="image-canvas"></canvas>
              <p style="text-align: center; font-weight: bold; margin-top: 0.5rem;">外側</p>
              <p style="text-align: center; color: #666; font-size: 0.85rem;"><i class="fas fa-pencil-alt"></i> ここをタップ/クリックしてマーキングできます</p>
            </div>
            <!-- マーキングツール -->
            <div style="width: 100%; margin-top: 1rem;">
              <div class="mark-controls" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.8rem;">
                <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                  <button type="button" class="tool-btn selected" data-tool="marker" data-canvas="1" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">マーカー</button>
                  <button type="button" class="tool-btn" data-tool="eraser" data-canvas="1" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">消しゴム</button>
                  <button type="button" class="tool-btn" data-tool="clear" data-canvas="1" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">クリア</button>
                </div>
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.3rem;">
                  <span style="font-size: 0.9rem;">画像1の色: </span>
                  <span class="color-option selected" data-color="#FF0000" data-canvas="1" style="background-color: #FF0000; width: 1.2rem; height: 1.2rem;"></span>
                  <span class="color-option" data-color="#00FF00" data-canvas="1" style="background-color: #00FF00; width: 1.2rem; height: 1.2rem;"></span>
                  <span class="color-option" data-color="#0000FF" data-canvas="1" style="background-color: #0000FF; width: 1.2rem; height: 1.2rem;"></span>
                </div>
              </div>
              <div class="mark-controls" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                  <button type="button" class="tool-btn selected" data-tool="marker" data-canvas="2" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">マーカー</button>
                  <button type="button" class="tool-btn" data-tool="eraser" data-canvas="2" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">消しゴム</button>
                  <button type="button" class="tool-btn" data-tool="clear" data-canvas="2" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">クリア</button>
                </div>
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.3rem;">
                  <span style="font-size: 0.9rem;">画像2の色: </span>
                  <span class="color-option selected" data-color="#FF0000" data-canvas="2" style="background-color: #FF0000; width: 1.2rem; height: 1.2rem;"></span>
                  <span class="color-option" data-color="#00FF00" data-canvas="2" style="background-color: #00FF00; width: 1.2rem; height: 1.2rem;"></span>
                  <span class="color-option" data-color="#0000FF" data-canvas="2" style="background-color: #0000FF; width: 1.2rem; height: 1.2rem;"></span>
                </div>
              </div>
            </div>
            <div style="flex: 1; min-width: 300px;">
              <p>Ottawa Ankle Rulesは、足関節捻挫時のX線撮影の必要性を評価するためのガイドラインです。</p>
              <p><strong>★1つでも当てはまれば骨折を疑いレントゲン撮影を推奨</strong></p>
              <ul style="margin-left: 1rem;">
                <li>腓骨遠位・外果の痛み（圧痛を含む）</li>
                <li>脛骨遠位・内果の痛み（圧痛を含む）</li>
                <li>受傷直後4歩以上歩けない</li>
                <li>舟状骨、第5中足骨の圧痛</li>
              </ul>
              <p><em>感度91%、特異度25%であり、OARの陽性は骨折確率が1.5倍に増加する</em></p>
              <p><em>注意点：特異度が低いため偽陽性の結果も出やすい</em></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 1. 急性期 -->
    <div class="tab-content" data-tab="acute">
      <h2>圧痛ポイントの診断と記録</h2>
      <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
        <!-- 画像1とマーキングキャンバス -->
        <div class="image-container" style="width: 45%; min-width: 250px; max-width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; padding: 10px; background: white; margin: 0 auto;">
          <img src="/3.png" alt="Ottawa Ankle Rules 1" style="width: 100%; display: block; border-radius: 5px;">
          <canvas id="markCanvas3" class="image-canvas"></canvas>
          <p style="text-align: center; font-weight: bold; margin-top: 0.5rem;">内側の圧痛ポイント</p>
          <p style="text-align: center; color: #666; font-size: 0.85rem;"><i class="fas fa-pencil-alt"></i> ここをタップ/クリックしてマーキングできます</p>
        </div>
        <!-- 画像2とマーキングキャンバス -->
        <div class="image-container" style="width: 45%; min-width: 250px; max-width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; padding: 10px; background: white; margin: 0 auto;">
          <img src="/4.png" alt="Ottawa Ankle Rules 2" style="width: 100%; display: block; border-radius: 5px;">
          <canvas id="markCanvas4" class="image-canvas"></canvas>
          <p style="text-align: center; font-weight: bold; margin-top: 0.5rem;">外側の圧痛ポイント</p>
          <p style="text-align: center; color: #666; font-size: 0.85rem;"><i class="fas fa-pencil-alt"></i> ここをタップ/クリックしてマーキングできます</p>
        </div>
        <!-- マーキングツール -->
        <div style="width: 100%; margin-top: 1rem;">
          <div class="mark-controls" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.8rem;">
            <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
              <button type="button" class="tool-btn selected" data-tool="marker" data-canvas="3" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">マーカー</button>
              <button type="button" class="tool-btn" data-tool="eraser" data-canvas="3" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">消しゴム</button>
              <button type="button" class="tool-btn" data-tool="clear" data-canvas="3" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">クリア</button>
            </div>
            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.3rem;">
              <span style="font-size: 0.9rem;">画像1の色: </span>
              <span class="color-option selected" data-color="#FF0000" data-canvas="3" style="background-color: #FF0000; width: 1.2rem; height: 1.2rem;"></span>
              <span class="color-option" data-color="#00FF00" data-canvas="3" style="background-color: #00FF00; width: 1.2rem; height: 1.2rem;"></span>
              <span class="color-option" data-color="#0000FF" data-canvas="3" style="background-color: #0000FF; width: 1.2rem; height: 1.2rem;"></span>
            </div>
          </div>
          <div class="mark-controls" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
              <button type="button" class="tool-btn selected" data-tool="marker" data-canvas="4" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">マーカー</button>
              <button type="button" class="tool-btn" data-tool="eraser" data-canvas="4" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">消しゴム</button>
              <button type="button" class="tool-btn" data-tool="clear" data-canvas="4" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">クリア</button>
            </div>
            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.3rem;">
              <span style="font-size: 0.9rem;">画像2の色: </span>
              <span class="color-option selected" data-color="#FF0000" data-canvas="4" style="background-color: #FF0000; width: 1.2rem; height: 1.2rem;"></span>
              <span class="color-option" data-color="#00FF00" data-canvas="4" style="background-color: #00FF00; width: 1.2rem; height: 1.2rem;"></span>
              <span class="color-option" data-color="#0000FF" data-canvas="4" style="background-color: #0000FF; width: 1.2rem; height: 1.2rem;"></span>
            </div>
          </div>
        </div>
      </div>
      
      <h2>痛み評価</h2>
      <label>VAS /10: <input type="number" name="acute_pain_vas" min="0" max="10" step="1"></label>
      <label><input type="checkbox" name="acute_pain_rest" /> 安静時痛あり</label>
      <label><input type="checkbox" name="acute_pain_move" /> 動作時痛あり</label>
      <label><input type="checkbox" name="acute_pain_weight" /> 荷重時痛あり</label>

      <h2>腫脹評価</h2>
      <label>足関節周径 (cm): <input type="number" name="acute_swelling_circ" step="0.1"></label>
      <p style="font-size:.85rem;color:#666;">※ 受傷3〜4日後からは自然回復傾向を確認</p>

      <h2>圧痛ポイント</h2>
      <div class="subsection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.8rem;">
        <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <input type="checkbox" name="tender_l_peroneus_longus" style="margin-right: 8px;"/> 
          <span>長腓骨筋</span>
        </label>
        <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <input type="checkbox" name="tender_s_peroneus_brevis" style="margin-right: 8px;"/> 
          <span>短腓骨筋</span>
        </label>
        <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <input type="checkbox" name="tender_atfl" style="margin-right: 8px;"/> 
          <span>前距腓靱帶</span>
        </label>
        <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <input type="checkbox" name="tender_cfl" style="margin-right: 8px;"/> 
          <span>踏腓靱帶</span>
        </label>
        <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <input type="checkbox" name="tender_deltoid" style="margin-right: 8px;"/> 
          <span>三角靱帶</span>
        </label>
        <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <input type="checkbox" name="tender_achilles" style="margin-right: 8px;"/> 
          <span>アキレスけん</span>
        </label>
        <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <input type="checkbox" name="tender_kager" style="margin-right: 8px;"/> 
          <span>Kager's fat pad</span>
        </label>
      </div>

      <h2>自他動運動</h2>
      <label><input type="checkbox" name="active_dorsiflex_pain" /> 背屈で疼痛</label>
    </div>

    <!-- 2. 亜急性期・回復期 -->
    <div class="tab-content" data-tab="subacute_recovery">
      <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
        <h2>亜急性期・回復期の評価</h2>
      </div>
      
      <h3>背屈可動域 (荷重下 WBLT)</h3>
      <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        <div style="min-width: 300px; flex: 1;">
          <label>母趾-壁距離(cm): <input type="number" id="wblt" name="wblt" step="0.1"></label>
          <span id="wbltTag" class="tag"></span>
          
          <div class="classification-table">
            <h4 style="margin-top: 0; margin-bottom: 0.5rem;">母趾-壁距離の分類</h4>
            <div class="classification-item">
              <span class="tag Hypomobile">Hypomobile</span> &lt; 6cm - 著しく制限あり
            </div>
            <div class="classification-item">
              <span class="tag Inflexible">Inflexible</span> 6-9cm - 制限あり
            </div>
            <div class="classification-item">
              <span class="tag Normal">Normal</span> 9-15cm - 正常範囲
            </div>
            <div class="classification-item">
              <span class="tag Flexible">Flexible</span> 15-18cm - 柔軟性あり
            </div>
            <div class="classification-item">
              <span class="tag Hypermobile">Hypermobile</span> ≥ 18cm - 過度の柔軟性
            </div>
          </div>
        </div>
        <div style="min-width: 300px; flex: 1;">
          <img src="/dorsiflexion_wblt.png" alt="背屈可動域 WBLT測定方法" class="reference-image">
          <p style="font-size: 0.9rem; color: #666;">壁に向かって立ち、足の母趾を壁につけた状態で、膝が壁に触れるまで前傾。このとき、踏が浮かない最大距離を測定。</p>
        </div>
      </div>

      <div style="display: flex; flex-wrap: wrap; gap: 2rem; margin-top: 1.5rem;">
        <div style="flex: 1; min-width: 300px;">
          <h3>早期機能評価</h3>
          <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">
            <label>背屈可動域 (非荷重) 度: <input type="number" name="dorsiflex_rom_nw" step="0.1"></label>
            <label>底屈筋力 (MMT /5): <input type="number" name="strength_pf" min="0" max="5"></label>
            <label>腓骨筋筋力 (MMT /5): <input type="number" name="strength_evert" min="0" max="5"></label>
            <label>片足静的保持 (秒): <input type="number" name="balance_single" step="1"></label>
          </div>
        </div>

        <div style="flex: 1; min-width: 300px;">
          <h3>SEBT / Yバランステスト</h3>
          <div style="margin-bottom: 1rem;">
            <h4>方向の選択</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
              <label><input type="checkbox" name="sebt_direction_ant" checked> 前方 (Anterior)</label>
              <label><input type="checkbox" name="sebt_direction_antlat"> 前外側 (Anterolateral)</label>
              <label><input type="checkbox" name="sebt_direction_lat"> 外側 (Lateral)</label>
              <label><input type="checkbox" name="sebt_direction_postlat" checked> 後外側 (Posterolateral)</label>
              <label><input type="checkbox" name="sebt_direction_post"> 後方 (Posterior)</label>
              <label><input type="checkbox" name="sebt_direction_postmed" checked> 後内側 (Posteromedial)</label>
              <label><input type="checkbox" name="sebt_direction_med"> 内側 (Medial)</label>
              <label><input type="checkbox" name="sebt_direction_antmed"> 前内側 (Anteromedial)</label>
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 1rem;">
        <h4>距離の入力 (cm)</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
          <label>前方: <input type="number" id="sebt_ant" name="sebt_ant" step="0.1" min="0" max="150"></label>
          <label>前外側: <input type="number" id="sebt_antlat" name="sebt_antlat" step="0.1" min="0" max="150"></label>
          <label>外側: <input type="number" id="sebt_lat" name="sebt_lat" step="0.1" min="0" max="150"></label>
          <label>後外側: <input type="number" id="sebt_postlat" name="sebt_postlat" step="0.1" min="0" max="150"></label>
          <label>後方: <input type="number" id="sebt_post" name="sebt_post" step="0.1" min="0" max="150"></label>
          <label>後内側: <input type="number" id="sebt_postmed" name="sebt_postmed" step="0.1" min="0" max="150"></label>
          <label>内側: <input type="number" id="sebt_med" name="sebt_med" step="0.1" min="0" max="150"></label>
          <label>前内側: <input type="number" id="sebt_antmed" name="sebt_antmed" step="0.1" min="0" max="150"></label>
        </div>
        <div style="margin-top: 1rem;">
          <button type="button" id="sebt_draw_btn" style="margin-right: 1rem;">入力した距離で図解表示</button>
          <button type="button" id="sebt_direction_only_btn">選択方向のみで表示（苦手方向確認）</button>
        </div>
      </div>
      
      <!-- 参照画像と図解 -->
      <div style="margin-top: 1.5rem;">
        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
          <div style="flex: 1; min-width: 200px;">
            <h4>バランステストの参照画像</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
              <div style="flex: 1; min-width: 150px;">
                <img src="/foot_directions.png" alt="足の方向" style="width: 100%; max-width: 300px; display: block; margin-bottom: 0.5rem;">
                <p style="font-size: 0.9rem; color: #666; margin-top: 0;">足の方向の参照</p>
              </div>
              <div style="flex: 1; min-width: 150px;">
                <img src="/star_balance.png" alt="スターバランステスト" style="width: 100%; max-width: 300px; display: block; margin-bottom: 0.5rem;">
                <p style="font-size: 0.9rem; color: #666; margin-top: 0;">スターバランステストの参照</p>
              </div>
            </div>
          </div>
          
          <div>
            <h3>結果の図解表示</h3>
            <div id="sebt_chart_container" style="position: relative; width: 100%; max-width: 400px; height: 400px; margin: 0 auto;">
              <canvas id="sebt_chart" width="400" height="400" style="display: block;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. スポーツ復帰評価 -->
    <div class="tab-content" data-tab="return">
      <h2>スポーツ復帰評価</h2>
      <p class="info">足関節捻挫からの復帰基準を評価します。各項目をチェックし、復帰評価を実施してください。</p>
      
      <div class="section">
        <h3>1. 痛み</h3>
        <div class="form-group">
          <label><input type="checkbox" name="rts_pain_check"> NRS/VAS 痛みがない/痛みの減少</label>
        </div>
      </div>
      
      <div class="section">
        <h3>2. 身体機能</h3>
        <div class="form-group">
          <label><input type="checkbox" name="rts_swelling_check"> 腫脹（周径の差）なし</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="rts_wblt_check"> 母趾壁距離テスト 左右差なし</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="rts_peroneal_check"> 腓骨筋筋力 左右差なし</label>
        </div>
      </div>
      
      <div class="section">
        <h3>3. 感覚運動制御</h3>
        <div class="form-group">
          <label><input type="checkbox" name="rts_proprioception_check"> 固有受容感覚（位置覚/運動覚）正常</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="rts_static_balance_check"> 静的片足バランステスト正常</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="rts_sebt_check"> SEBT 健側の80%以上</label>
        </div>
      </div>
      
      <div class="section">
        <h3>4. スポーツパフォーマンス</h3>
        <div class="form-group">
          <label><input type="checkbox" name="rts_vertical_jump_check"> 垂直ジャンプテスト 健側の90%以上</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="rts_hop_test_check"> シングル/サイドホップテスト 健側の80%以上</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="rts_agility_check"> アジリティTテスト (年齢相応)</label>
          <div class="info" style="font-size: 0.8em; margin-top: 5px;">
            小学生: 12〜14秒 / 中学生: 10〜12秒 / 高校生: 8〜10秒 / 成人: 8.9〜13.5秒
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>5. 心理的要因</h3>
        <div class="form-group">
          <label><input type="checkbox" name="rts_confidence_check"> 足関節への自信/安心感</label>
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="rts_mental_check"> 復帰への心理的準備</label>
        </div>
      </div>
      
      <div class="section results">
        <h3>総合評価</h3>
        <button type="button" id="rtsPaassCheckBtn" class="btn">項目の達成状況を確認</button>
        <div id="rtsPaassResults" style="margin-top: 10px; display: none;">
          <div class="result-box" style="padding: 10px;">
            <div id="rtsPaassChecked" class="total-score"></div>
          </div>
        </div>
        <button type="button" id="rtsEvalBtn" class="btn" style="margin-top: 15px;">評価結果を表示</button>
        <div id="rtsResults" class="result-box">
          <div id="rtsPentagonContainer" style="width: 100%; height: 350px; position: relative;">
            <canvas id="rtsPentagon" width="400" height="350"></canvas>
          </div>
          <div id="rtsTotal" class="total-score"></div>
          <div id="rtsRecommendation" class="recommendation"></div>
          <p class="info" style="margin-top: 15px;">注意: 五角形の各頂点は評価カテゴリーを表し、形状が大きいほど復帰に近い状態です。収縮している頂点の項目に特に注目が必要です。</p>
        </div>
      </div>
    </div>

    <!-- 5. 競技復帰評価 -->
    <div class="tab-content" data-tab="competition">
      <h2>競技復帰評価</h2>
      <p class="info">CAI機能テストは慢性足関節不安定症の包括的評価ツールです。7つのテスト項目を評価し、25点満点でスコア化します。カットオフ値8点未満で受傷前の競技レベルに復帰可能と判断します。</p>
      
      <div class="section">
        <h3>A. 機能テスト評価</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
          <!-- 左カラム: テスト1-3 -->
          <div style="flex: 1; min-width: 300px;">
            <div class="subsection">
              <h4>1. 片脚立位テスト (SLS)</h4>
              <p>目を閉じて片脚立位を30秒間保持</p>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_sls" value="0"> 完遂 (0点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_sls" value="1"> 不安定さあり (1点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_sls" value="4"> 完遂不可 (4点)
                </label>
              </div>
            </div>
            
            <div class="subsection">
              <h4>2. 修正型スターエクスカーションバランステスト (mSEBT)</h4>
              <p>前方・後外側・後内側の3方向の到達距離を測定し、健側と比較</p>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_msebt" value="0"> 健側の≧90% (0点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_msebt" value="2"> 健側の80-90% (2点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_msebt" value="3"> 健側の<80% (3点)
                </label>
              </div>
            </div>
            
            <div class="subsection">
              <h4>3. サイドホップテスト (SHT)</h4>
              <p>30cmの距離を10往復ジャンプ</p>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_sht" value="0"> 健側の≧90% (0点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_sht" value="2"> 健側の80-90% (2点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_sht" value="4"> 健側の<80% (4点)
                </label>
              </div>
            </div>
          </div>
          
          <!-- 右カラム: テスト4-7 -->
          <div style="flex: 1; min-width: 300px;">
            <div class="subsection">
              <h4>4. 8の字ホップテスト (F8T)</h4>
              <p>5mの8の字を2周ホッピング</p>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_f8t" value="0"> 健側の≧90% (0点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_f8t" value="2"> 健側の80-90% (2点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_f8t" value="4"> 健側の<80% (4点)
                </label>
              </div>
            </div>
            
            <div class="subsection">
              <h4>5. ALR-RSI 心理的準備性尺度</h4>
              <p>復帰への心理的準備性を評価する12項目の質問</p>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_alr_rsi" value="0"> ≧60点 (0点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_alr_rsi" value="1"> 40-60点 (1点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_alr_rsi" value="5"> <40点 (5点)
                </label>
              </div>
              <button type="button" id="showAlrRsiBtn" class="btn-small">ALR-RSI質問項目を表示</button>
            </div>
            
            <div class="subsection">
              <h4>6. FAAM ADL サブスケール</h4>
              <p>日常生活動作の自己評価</p>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_faam_adl" value="0"> ≧90% (0点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_faam_adl" value="1"> 80-90% (1点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_faam_adl" value="2"> <80% (2点)
                </label>
              </div>
            </div>
            
            <div class="subsection">
              <h4>7. FAAM スポーツサブスケール</h4>
              <p>スポーツ活動の自己評価</p>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_faam_sports" value="0"> ≧80% (0点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_faam_sports" value="2"> 60-80% (2点)
                </label>
              </div>
              <div class="form-group">
                <label>
                  <input type="radio" name="cai_faam_sports" value="3"> <60% (3点)
                </label>
              </div>
              <button type="button" id="showFaamBtn" class="btn-small">FAAM質問項目を表示</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>B. ALR-RSI 心理的準備性尺度</h3>
        <div id="alrRsiPanel" style="display: none;">
          <p class="info">各項目を0-100の範囲で評価し、平均点を算出します。カットオフ値は60点で、これを下回ると心理的準備ができていない可能性があります。</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
            <div class="slider-container">
              <p>1. スポーツ復帰後の再受傷に対する不安</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi1">
              <div class="slider-labels">
                <span>非常に不安 (0)</span>
                <span>全く不安なし (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>2. スポーツ時に足首について考える頻度</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi2">
              <div class="slider-labels">
                <span>常に考える (0)</span>
                <span>全く考えない (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>3. 足首への自信</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi3">
              <div class="slider-labels">
                <span>全く自信なし (0)</span>
                <span>完全に自信あり (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>4. 足首の安定性に関する自信</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi4">
              <div class="slider-labels">
                <span>全く自信なし (0)</span>
                <span>完全に自信あり (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>5. 全力でプレイできる自信</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi5">
              <div class="slider-labels">
                <span>全く自信なし (0)</span>
                <span>完全に自信あり (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>6. 足首に対する不安感</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi6">
              <div class="slider-labels">
                <span>常に不安 (0)</span>
                <span>全く不安なし (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>7. 足首の状態について考える頻度</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi7">
              <div class="slider-labels">
                <span>常に考える (0)</span>
                <span>全く考えない (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>8. 試合で全力プレイを控える頻度</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi8">
              <div class="slider-labels">
                <span>常に控える (0)</span>
                <span>全く控えない (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>9. 足首の違和感頻度</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi9">
              <div class="slider-labels">
                <span>常にある (0)</span>
                <span>全くない (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>10. 他の選手との比較での能力発揮</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi10">
              <div class="slider-labels">
                <span>まったく発揮できない (0)</span>
                <span>完全に発揮できる (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>11. 足首が回復したという実感</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi11">
              <div class="slider-labels">
                <span>全く回復していない (0)</span>
                <span>完全に回復した (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
            <div class="slider-container">
              <p>12. 足首の動きへの信頼感</p>
              <input type="range" min="0" max="100" value="50" class="slider" id="alrRsi12">
              <div class="slider-labels">
                <span>全く信頼していない (0)</span>
                <span>完全に信頼している (100)</span>
              </div>
              <p class="slider-value">50</p>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <button type="button" id="calcAlrRsiBtn" class="btn">ALR-RSI平均点を計算</button>
            <div id="alrRsiResult" class="result-box" style="margin-top: 10px; display: none;">
              <div id="alrRsiScore" class="total-score"></div>
              <div id="alrRsiEvaluation" class="recommendation"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>C. FAAM（足部および足関節能力測定）</h3>
        <div id="faamPanel" style="display: none;">
          <p class="info">FAAM（Foot and Ankle Ability Measure）は足部・足関節の機能状態を評価する自己記入式調査票です。日常生活活動（ADL）サブスケール21項目と、スポーツサブスケール8項目で構成されます。</p>
          
          <!-- ADLサブスケール -->
          <div class="subsection">
            <h4>FAAM ADLサブスケール</h4>
            <p>各項目について、現在の能力を評価してください：</p>
            <p>0 = 不可能、1 = かなり困難、2 = 中程度困難、3 = やや困難、4 = 困難なし、NA = 該当なし</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 0.5rem; margin-top: 10px;">
              <div class="faam-item">
                <p>1. 立位</p>
                <select id="faamAdl1">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <div class="faam-item">
                <p>2. 平地歩行</p>
                <select id="faamAdl2">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <div class="faam-item">
                <p>3. 不整地歩行</p>
                <select id="faamAdl3">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <!-- 他のADL項目（スペース制約のため一部のみ表示） -->
              <div class="faam-item">
                <p>4. 階段昇り</p>
                <select id="faamAdl4">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <div class="faam-item">
                <p>5. 階段降り</p>
                <select id="faamAdl5">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
            </div>
            <div style="margin-top: 15px;">
              <p>※ 実際のFAAM ADLは21項目ありますが、画面スペースの都合上、代表的な5項目のみ表示しています。総合評価では、最低でも80%（約17項目）の回答が必要です。</p>
            </div>
          </div>
          
          <!-- スポーツサブスケール -->
          <div class="subsection" style="margin-top: 20px;">
            <h4>FAAMスポーツサブスケール</h4>
            <p>各項目について、現在の能力を評価してください：</p>
            <p>0 = 不可能、1 = かなり困難、2 = 中程度困難、3 = やや困難、4 = 困難なし、NA = 該当なし</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 0.5rem; margin-top: 10px;">
              <div class="faam-item">
                <p>1. ランニング</p>
                <select id="faamSport1">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <div class="faam-item">
                <p>2. ジャンプ</p>
                <select id="faamSport2">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <div class="faam-item">
                <p>3. 着地</p>
                <select id="faamSport3">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <div class="faam-item">
                <p>4. 急な方向転換</p>
                <select id="faamSport4">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
              <div class="faam-item">
                <p>5. 低速での運動</p>
                <select id="faamSport5">
                  <option value="4">困難なし</option>
                  <option value="3">やや困難</option>
                  <option value="2">中程度困難</option>
                  <option value="1">かなり困難</option>
                  <option value="0">不可能</option>
                  <option value="na">該当なし</option>
                </select>
              </div>
            </div>
            <div style="margin-top: 15px;">
              <p>※ 実際のFAAMスポーツサブスケールは8項目ありますが、画面スペースの都合上、代表的な5項目のみ表示しています。総合評価では、最低でも80%（約6項目）の回答が必要です。</p>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <button type="button" id="calcFaamBtn" class="btn">FAAM得点を計算</button>
            <div id="faamResult" class="result-box" style="margin-top: 10px; display: none;">
              <div id="faamAdlScore" class="score-item"></div>
              <div id="faamSportScore" class="score-item"></div>
              <div id="faamEvaluation" class="recommendation"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="section results">
        <h3>CAI機能テスト総合評価</h3>
        <button type="button" id="caiEvalBtn" class="btn">CAI機能テストの総合点を計算</button>
        <div id="caiResults" class="result-box" style="margin-top: 10px; display: none;">
          <div id="caiTotal" class="total-score"></div>
          <div id="caiEvaluation" class="recommendation"></div>
          <p class="info" style="margin-top: 10px;">カットオフ値: 8点未満 ⇒ 受傷前の競技レベルに復帰可能</p>
          <p class="info">各項目の得点: <span id="caiDetailScores"></span></p>
        </div>
      </div>
    </div>

    <button type="submit" id="saveAllBtn" style="background-color: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; font-size: 1.1rem; cursor: pointer;">評価を保存</button>
  <div id="saveConfirmation" style="display: none; margin-top: 1rem; padding: 0.5rem; background-color: #d4edda; color: #155724; border-radius: 5px;">データが正常に保存されました</div>
</form>

    <!-- 6. データ履歴 -->
    <div class="tab-content" data-tab="history">
      <h2>評価データ履歴</h2>
      <p class="info">保存された評価データの一覧です。データをクリックすると詳細を確認できます。</p>
      
      <div class="section">
        <div class="history-controls" style="margin-bottom: 1rem;">
          <button type="button" id="refreshHistoryBtn" style="background-color: #6a75eb; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-right: 0.5rem;">履歴を更新</button>
          <button type="button" id="clearHistoryBtn" style="background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">すべての履歴を削除</button>
        </div>
        
        <div id="historyList" style="margin-top: 1rem;">
          <div class="empty-history-message">保存されたデータがありません。評価を実施して保存してください。</div>
        </div>
        
        <div id="historyDetail" style="margin-top: 2rem; display: none;">
          <h3>評価詳細</h3>
          <div id="historyDetailContent"></div>
        </div>
      </div>
    </div>

</div> <!-- container end -->

  <script>
    // --- タブ切り替え ---
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // 現在のタブを非アクティブ化
        document.querySelector('.tab.active').classList.remove('active');
        // クリックされたタブをアクティブ化
        tab.classList.add('active');
        
        // すべてのタブコンテンツを非表示
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        
        // 選択されたタブのコンテンツを表示
        const tabName = tab.dataset.tab;
        document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
        
        // 履歴タブがクリックされた場合は履歴データを表示
        if (tabName === 'history') {
          displayHistoryList();
        }
      });
    });

    // --- Ottawa Rule 判定 ---
    const ottawaInputs = document.querySelectorAll('[name^="ottawa_"]');
    ottawaInputs.forEach(i => i.addEventListener('change', ottawaCheck));
    ottawaCheck();
    function ottawaCheck() {
      const anyChecked = [...ottawaInputs].some(i => i.checked);
      document.getElementById('ottawaResult').textContent = anyChecked ? '▶ 骨折の可能性あり → X線を推奨' : '';
    }

    // --- 背屈可動域タグ付け ---
    const wbltInput = document.getElementById('wblt');
    wbltInput.addEventListener('input', updateWBLTTag);
    function updateWBLTTag() {
      const v = parseFloat(wbltInput.value);
      const tag = document.getElementById('wbltTag');
      if (isNaN(v)) { tag.textContent = ''; tag.className = 'tag'; return; }
      let label = '', cls='';
      if (v < 6) { label='Hypomobile'; cls='Hypomobile'; }
      else if (v < 9) { label='Inflexible'; cls='Inflexible'; }
      else if (v < 15) { label='Normal'; cls='Normal'; }
      else if (v < 18) { label='Flexible'; cls='Flexible'; }
      else { label='Hypermobile'; cls='Hypermobile'; }
      tag.textContent = label; tag.className = 'tag ' + cls;
    }

    // --- 保存 (localStorage) ---
    const form = document.getElementById('evalForm');
    // ロード
    window.addEventListener('DOMContentLoaded', () => {
      const savedData = JSON.parse(localStorage.getItem('ankleEvalForm') || '{}');
      for (const key in savedData) {
        const el = document.querySelector(`[name="${key}"]`);
        if (el) {
          if (el.type === 'checkbox') {
            el.checked = savedData[key];
          } else {
            el.value = savedData[key];
          }
        }
      }
      // この部分は以前のシンプルな保存ロジックで、saveAllData()に統合されるべきですが、
      // 混乱を避けるため、元のロジックも残しておきます。
      // 通常はloadAllData()で復元し、saveAllData()で保存します。
      // 以下の部分をコメントアウトまたは削除し、saveAllData() と loadAllData() を主に使うことを推奨します。
      /*
      const data = {};
      [...form.elements].forEach(el => {
        if (!el.name) return;
        data[el.name] = el.type === 'checkbox' ? el.checked : el.value;
      });
      localStorage.setItem('ankleEval', JSON.stringify(data));
      alert('保存しました (ブラウザのローカルストレージ)');
      */
    });

// --- 画像マーキング機能 ---
const canvases = {
  1: document.getElementById('markCanvas1'),
  2: document.getElementById('markCanvas2'),
  3: document.getElementById('markCanvas3'),
  4: document.getElementById('markCanvas4')
};
const contexts = {};
const markData = {
  1: [],
  2: [],
  3: [],
  4: []
};
let isDrawing = false;
const currentTool = {
  1: 'marker',
  2: 'marker',
  3: 'marker',
  4: 'marker'
};
const currentColor = {
  1: '#FF0000',
  2: '#FF0000',
  3: '#FF0000',
  4: '#FF0000'
};

// キャンバスのサイズを画像に合わせる
function updateCanvasSize(canvasId) {
  const canvas = canvases[canvasId];
  if (!canvas) return;
  
  const img = canvas.previousElementSibling; // `img` 要素を取得
  if (!img || !(img instanceof HTMLImageElement)) {
    console.error(`Canvas ${canvasId} の前に img 要素が見つかりません。`);
    return;
  }
  
  // 画像の実際の表示サイズを取得
  const style = window.getComputedStyle(img);
  const width = parseInt(style.width, 10);
  const height = parseInt(style.height, 10);

  if (width > 0 && height > 0) {
    canvas.width = width;
    canvas.height = height;
    contexts[canvasId] = canvas.getContext('2d');
    redrawMarks(canvasId);
  } else {
    // 画像がまだ読み込まれていないか、非表示の場合のフォールバック
    // 画像の naturalWidth/Height を使うか、少し待って再試行する
    if (img.naturalWidth > 0 && img.naturalHeight > 0) {
        // naturalWidth/Height を元にアスペクト比を保って調整することも可能
        // ここでは、offsetWidth/Heightが取得できるまで待つシンプルな実装
        setTimeout(() => updateCanvasSize(canvasId), 100);
    }
  }
}


// 画像サイズ変更時にキャンバスサイズも更新
window.addEventListener('resize', () => {
  for (let i = 1; i <= 4; i++) {
    if (canvases[i]) updateCanvasSize(i);
  }
});

// ページ読み込み時に実行
window.addEventListener('DOMContentLoaded', () => {
  for (let i = 1; i <= 4; i++) {
    const canvas = canvases[i];
    if (canvas) {
      const img = canvas.previousElementSibling;
      if (img && img instanceof HTMLImageElement) {
        if (img.complete) {
          updateCanvasSize(i);
        } else {
          img.onload = () => updateCanvasSize(i);
          // エラーハンドリングも追加すると良い
          img.onerror = () => console.error(`画像の読み込みに失敗しました: ${img.src}`);
        }
      }
      // ローカルストレージからマーク情報を復元
      const savedMarks = localStorage.getItem(`ankleEval_marks_${i}`);
      if (savedMarks) {
        try {
          markData[i] = JSON.parse(savedMarks);
          if (contexts[i]) { // contextが初期化されていれば再描画
             redrawMarks(i);
          }
        } catch (e) {
          console.error(`マークデータ ${i} のパースに失敗しました:`, e);
          markData[i] = []; // エラー時はリセット
        }
      }
    }
  }
});

// マーカーツール選択
document.querySelectorAll('.tool-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const tool = this.dataset.tool;
    const canvasId = parseInt(this.dataset.canvas);
    
    if (!canvases[canvasId]) return; // 対象キャンバスがない場合は何もしない

    if (tool === 'clear') {
      if (confirm('この画像のマークをすべて消去しますか？')) {
        markData[canvasId] = [];
        redrawMarks(canvasId);
        saveMarks(canvasId);
      }
      return;
    }
    
    document.querySelectorAll(`.tool-btn[data-canvas="${canvasId}"]`).forEach(b => {
      if (b.dataset.tool !== 'clear') b.classList.remove('selected');
    });
    if (this.dataset.tool !== 'clear') this.classList.add('selected');
    
    currentTool[canvasId] = tool;
  });
});

// 色選択
document.querySelectorAll('.color-option').forEach(option => {
  option.addEventListener('click', function() {
    const color = this.dataset.color;
    const canvasId = parseInt(this.dataset.canvas);
    
    if (!canvases[canvasId]) return; // 対象キャンバスがない場合は何もしない

    document.querySelectorAll(`.color-option[data-canvas="${canvasId}"]`).forEach(o => {
      o.classList.remove('selected');
    });
    this.classList.add('selected');
    
    currentColor[canvasId] = color;
  });
});

// 描画イベント
for (let canvasId = 1; canvasId <= 4; canvasId++) {
  const canvas = canvases[canvasId];
  if (!canvas) continue;
  
  const startDrawHandler = (e) => {
    if (e.type === 'touchstart') e.preventDefault();
    isDrawing = true;
    const pos = getMousePos(canvas, e);
    markData[canvasId].push({
        x: pos.x, y: pos.y, 
        tool: currentTool[canvasId], 
        color: currentColor[canvasId], 
        lineWidth: currentTool[canvasId] === 'marker' ? 5 : 20,
        type: 'start' // ストロークの開始を示す
    });
    drawMark(canvasId, pos.x, pos.y, true); // 1点目を描画
  };

  const drawHandler = (e) => {
    if (!isDrawing) return;
    if (e.type === 'touchmove') e.preventDefault();
    const pos = getMousePos(canvas, e);
    markData[canvasId].push({
        x: pos.x, y: pos.y, 
        tool: currentTool[canvasId], 
        color: currentColor[canvasId], 
        lineWidth: currentTool[canvasId] === 'marker' ? 5 : 20,
        type: 'draw' // ストロークの途中を示す
    });
    drawMark(canvasId, pos.x, pos.y, false);
  };

  const stopDrawHandler = (e) => {
    if (!isDrawing) return;
    isDrawing = false;
    markData[canvasId].push({type: 'end'}); // ストロークの終了を示す
    saveMarks(canvasId);
    redrawMarks(canvasId); // 最終的な再描画で線を滑らかにする
  };

  canvas.addEventListener('mousedown', startDrawHandler);
  canvas.addEventListener('mousemove', drawHandler);
  canvas.addEventListener('mouseup', stopDrawHandler);
  canvas.addEventListener('mouseout', stopDrawHandler);
  
  canvas.addEventListener('touchstart', startDrawHandler, { passive: false });
  canvas.addEventListener('touchmove', drawHandler, { passive: false });
  canvas.addEventListener('touchend', stopDrawHandler);
}

function getMousePos(canvas, evt) {
  const rect = canvas.getBoundingClientRect();
  let clientX, clientY;
  if (evt.touches && evt.touches.length > 0) {
    clientX = evt.touches[0].clientX;
    clientY = evt.touches[0].clientY;
  } else if (evt.changedTouches && evt.changedTouches.length > 0) { // touchend用
    clientX = evt.changedTouches[0].clientX;
    clientY = evt.changedTouches[0].clientY;
  }
  else {
    clientX = evt.clientX;
    clientY = evt.clientY;
  }
  return {
    x: clientX - rect.left,
    y: clientY - rect.top
  };
}


function drawMark(canvasId, x, y, isStart) {
    const ctx = contexts[canvasId];
    if (!ctx) return;

    const lastPoint = markData[canvasId].length > 1 ? markData[canvasId][markData[canvasId].length - (isStart ? 1 : 2)] : null;
    const currentPoint = markData[canvasId][markData[canvasId].length - 1];

    if (!currentPoint || currentPoint.type === 'end') return;


    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = currentPoint.lineWidth;

    if (currentPoint.tool === 'marker') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = currentPoint.color;
    } else { // eraser
        ctx.globalCompositeOperation = 'destination-out';
        // 消しゴムの色は実際には影響しないが、透明度1の黒などを設定
        ctx.strokeStyle = 'rgba(0,0,0,1)';
    }

    ctx.beginPath();
    if (isStart || !lastPoint || lastPoint.type === 'end' || lastPoint.type === 'start' && markData[canvasId].filter(p => p.type === 'draw').length === 0) {
        // 新しいストロークの開始点、または単一点
        ctx.moveTo(currentPoint.x - 0.5, currentPoint.y); // 小さな円を描くために少しずらす
        ctx.lineTo(currentPoint.x, currentPoint.y);
    } else {
        ctx.moveTo(lastPoint.x, lastPoint.y);
        ctx.lineTo(currentPoint.x, currentPoint.y);
    }
    ctx.stroke();
}


function redrawMarks(canvasId) {
  const ctx = contexts[canvasId];
  const canvas = canvases[canvasId];
  if (!ctx || !canvas) return;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  let lastValidPoint = null;

  for (const point of markData[canvasId]) {
    if (point.type === 'start') {
      lastValidPoint = point; // 次の描画のために開始点を保持
      // 開始点自体も小さな円として描画（オプション）
      ctx.beginPath();
      ctx.arc(point.x, point.y, point.lineWidth / 2, 0, Math.PI * 2);
      ctx.fillStyle = point.tool === 'marker' ? point.color : 'rgba(0,0,0,0)'; // 消しゴムは透明
      ctx.globalCompositeOperation = point.tool === 'marker' ? 'source-over' : 'destination-out';
      ctx.fill();
    } else if (point.type === 'draw' && lastValidPoint) {
      ctx.beginPath();
      ctx.moveTo(lastValidPoint.x, lastValidPoint.y);
      ctx.lineTo(point.x, point.y);
      
      ctx.lineWidth = point.lineWidth;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      if (point.tool === 'marker') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = point.color;
      } else { // eraser
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,1)'; 
      }
      ctx.stroke();
      lastValidPoint = point;
    } else if (point.type === 'end') {
      lastValidPoint = null; // ストローク終了
    }
  }
   ctx.globalCompositeOperation = 'source-over'; // デフォルトに戻す
}

// マークデータの保存
function saveMarks(canvasId) {
  if (markData[canvasId]) {
    localStorage.setItem(`ankleEval_marks_${canvasId}`, JSON.stringify(markData[canvasId]));
  }
}


    // --- SEBT / Yバランステストの図解表示 ---
    const sebtCanvas = document.getElementById('sebt_chart');
    const sebtCtx = sebtCanvas ? sebtCanvas.getContext('2d') : null;
    const sebtDrawBtn = document.getElementById('sebt_draw_btn');
    const sebtDirectionOnlyBtn = document.getElementById('sebt_direction_only_btn');

    // 方向と角度のマッピング
    const directions = {
      'ant': { name: '前方', angle: 90, inputId: 'sebt_ant' },
      'antlat': { name: '前外側', angle: 45, inputId: 'sebt_antlat' },
      'lat': { name: '外側', angle: 0, inputId: 'sebt_lat' },
      'postlat': { name: '後外側', angle: 315, inputId: 'sebt_postlat' },
      'post': { name: '後方', angle: 270, inputId: 'sebt_post' },
      'postmed': { name: '後内側', angle: 225, inputId: 'sebt_postmed' },
      'med': { name: '内側', angle: 180, inputId: 'sebt_med' },
      'antmed': { name: '前内側', angle: 135, inputId: 'sebt_antmed' }
    };
    
    // input要素を事前に取得
    for (const dir in directions) {
        directions[dir].input = document.getElementById(directions[dir].inputId);
    }


    // 方向のチェックボックスの読み込み
    const directionCheckboxes = {};
    for (const dir in directions) {
      const checkbox = document.querySelector(`[name="sebt_direction_${dir}"]`);
      if (checkbox) {
        directionCheckboxes[dir] = checkbox;
      }
    }

    if (sebtDrawBtn && sebtCtx) {
      sebtDrawBtn.addEventListener('click', () => drawSebtChart(false));
      
      // 初期化時に一度描画
      setTimeout(() => drawSebtChart(false), 500); // ページ読み込み後に実行
    }

    if (sebtDirectionOnlyBtn && sebtCtx) {
      sebtDirectionOnlyBtn.addEventListener('click', () => drawSebtChart(true));
    }

function drawSebtChart(directionOnly = false) {
  if (!sebtCtx) return;
  
  const width = sebtCanvas.width;
  const height = sebtCanvas.height;
  const centerX = width / 2;
  const centerY = height / 2;
  const maxRadius = Math.min(width, height) * 0.40; // 少し小さくしてラベルスペース確保
  
  sebtCtx.clearRect(0, 0, width, height);
  drawGrid(sebtCtx, centerX, centerY, maxRadius, directionOnly);
  
  const selectedDirectionsData = [];
  const polygonPoints = []; // 多角形描画用の点
  
  for (const dirKey in directions) {
    const dirInfo = directions[dirKey];
    const checkbox = directionCheckboxes[dirKey];
    
    if (checkbox && checkbox.checked) {
      const angleRad = dirInfo.angle * Math.PI / 180;
      let value = 0;
      let radius = 0;
      let pointX, pointY;
      let hasInputValue = false;

      if (dirInfo.input && dirInfo.input.value) {
        value = parseFloat(dirInfo.input.value);
        if (!isNaN(value)) {
          radius = (Math.min(value, 150) / 150) * maxRadius; // 最大150cmとして正規化
          hasInputValue = true;
        }
      }
      
      if (directionOnly && !hasInputValue) { // 方向のみモードで値がない場合
        radius = maxRadius * 0.7; // 固定の半径で表示 (例: 70%の位置)
        value = (radius / maxRadius) * 150; // 相当するcm値を計算
      } else if (!hasInputValue && !directionOnly) { // 通常モードで値がない場合は0として扱う
         radius = 0;
         value = 0;
      }


      pointX = centerX + radius * Math.cos(angleRad);
      pointY = centerY - radius * Math.sin(angleRad);
      
      selectedDirectionsData.push({
        name: dirInfo.name,
        angleRad: angleRad,
        value: value, // cm単位の値
        x: pointX,
        y: pointY,
        hasValue: hasInputValue 
      });
      
      if (hasInputValue || directionOnly) { // 値があるか、方向のみモードなら多角形用の点を追加
          polygonPoints.push({ x: pointX, y: pointY, angle: dirInfo.angle });
      }
    }
  }

  // 角度順にソートして多角形を正しく描画
  polygonPoints.sort((a, b) => a.angle - b.angle);


  drawSelectedAxes(sebtCtx, centerX, centerY, maxRadius, selectedDirectionsData, directionOnly);
  
  if (!directionOnly && polygonPoints.length > 0) {
    drawDataPointsAndPolygon(sebtCtx, polygonPoints, selectedDirectionsData, centerX, centerY, maxRadius);
  } else if (directionOnly && polygonPoints.length > 0) {
    // 方向のみモードのタイトル
    sebtCtx.fillStyle = '#333';
    sebtCtx.font = 'bold 14px Arial';
    sebtCtx.textAlign = 'center';
    sebtCtx.textBaseline = 'top';
    sebtCtx.fillText('苦手方向確認モード', centerX, 10);
    // 方向のみモードでも、選択された軸上の点を強調表示
    selectedDirectionsData.forEach(dirData => {
        if (dirData.value > 0) { // 値がある（または固定値が設定された）場合のみ
            sebtCtx.beginPath();
            sebtCtx.arc(dirData.x, dirData.y, 5, 0, Math.PI * 2);
            sebtCtx.fillStyle = 'rgba(0, 120, 255, 0.5)'; // 半透明の青
            sebtCtx.fill();
        }
    });
  }
}

function drawGrid(ctx, centerX, centerY, maxRadius, directionOnly = false) {
  ctx.strokeStyle = '#e0e0e0';
  ctx.fillStyle = '#f8f9fa'; // 背景色
  
  // 外円 (背景)
  ctx.beginPath();
  ctx.arc(centerX, centerY, maxRadius, 0, Math.PI * 2);
  ctx.fill();
  // ctx.stroke(); // 外枠線

  const numCircles = 5; // 20cm, 40cm, 60cm, 80cm, 100cm (最大100cmを想定)
                      // 150cmまで対応させるなら numCircles を 7 or 8 に
  const maxGridValue = 100; // グリッドの最大値(cm)

  for (let i = 1; i <= numCircles; i++) {
    const currentGridValue = (maxGridValue / numCircles) * i; // 20, 40, 60, 80, 100
    const radius = (currentGridValue / 150) * maxRadius; // 150cmを最大として半径を計算
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.strokeStyle = '#d0d0d0'; // 少し濃いめのグレー
    ctx.stroke();
    
    ctx.fillStyle = '#666';
    ctx.font = '10px Arial';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    // X軸の右側に目盛りを表示 (0度の方向)
    // Y軸の上側 (90度) や他の位置にも追加可能
    ctx.fillText(`${currentGridValue}cm`, centerX + radius + 15, centerY); 
  }
  
  // 中心点
  ctx.fillStyle = '#333';
  ctx.beginPath();
  ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
  ctx.fill();
}

function drawSelectedAxes(ctx, centerX, centerY, maxRadius, selectedDirectionsData, directionOnly = false) {
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 2]); // 点線
  
  selectedDirectionsData.forEach(dirData => {
    ctx.strokeStyle = dirData.hasValue || directionOnly ? '#888' : '#ccc'; // 値があるか方向のみなら濃いめ
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    const xEnd = centerX + maxRadius * Math.cos(dirData.angleRad);
    const yEnd = centerY - maxRadius * Math.sin(dirData.angleRad);
    ctx.lineTo(xEnd, yEnd);
    ctx.stroke();
    
    // ラベル
    ctx.fillStyle = '#333';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const labelRadius = maxRadius + 15;
    const labelX = centerX + labelRadius * Math.cos(dirData.angleRad);
    const labelY = centerY - labelRadius * Math.sin(dirData.angleRad);
    ctx.fillText(dirData.name, labelX, labelY);
  });
  
  ctx.setLineDash([]); // 実線に戻す
}

function drawDataPointsAndPolygon(ctx, polygonPoints, selectedDirectionsData, centerX, centerY, maxRadius) {
  // 多角形
  if (polygonPoints.length >= 3) {
    ctx.beginPath();
    polygonPoints.forEach((p, index) => {
      if (index === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.closePath();
    ctx.fillStyle = 'rgba(0, 120, 255, 0.3)';
    ctx.fill();
    ctx.strokeStyle = 'rgba(0, 80, 200, 0.7)';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }

  // データ点と数値
  selectedDirectionsData.forEach(dirData => {
    if (dirData.hasValue) { // 値が入力された点のみ
      ctx.beginPath();
      ctx.arc(dirData.x, dirData.y, 4, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255, 0, 0, 0.8)'; // 赤い点
      ctx.fill();

      // 数値 (点の少し外側に表示)
      ctx.fillStyle = '#000';
      ctx.font = '10px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const textOffsetX = 10 * Math.cos(dirData.angleRad); // X方向オフセット
      const textOffsetY = -10 * Math.sin(dirData.angleRad); // Y方向オフセット
      // ラベルが重ならないように調整（簡易的）
      let valuePosX = dirData.x + textOffsetX;
      let valuePosY = dirData.y + textOffsetY;

      // 画面端にはみ出さないように調整
      if (valuePosX < 15) valuePosX = 15;
      if (valuePosX > ctx.canvas.width - 15) valuePosX = ctx.canvas.width - 15;
      if (valuePosY < 10) valuePosY = 10;
      if (valuePosY > ctx.canvas.height - 10) valuePosY = ctx.canvas.height - 10;


      ctx.fillText(`${dirData.value.toFixed(1)}`, valuePosX, valuePosY);
    }
  });
}


// スポーツ復帰評価の五角形チャートを描画
const rtsPentagonCanvas = document.getElementById('rtsPentagon');
const rtsPentagonCtx = rtsPentagonCanvas ? rtsPentagonCanvas.getContext('2d') : null;
const rtsEvalBtn = document.getElementById('rtsEvalBtn');
const rtsPaassCheckBtn = document.getElementById('rtsPaassCheckBtn');


if (rtsPaassCheckBtn) {
    rtsPaassCheckBtn.addEventListener('click', () => {
        const checkboxes = [
            { name: '痛み', input: 'rts_pain_check' },
            { name: '腫脹', input: 'rts_swelling_check' },
            { name: 'WBLT', input: 'rts_wblt_check' },
            { name: '腓骨筋筋力', input: 'rts_peroneal_check' },
            { name: '固有受容感覚', input: 'rts_proprioception_check' },
            { name: '静的バランス', input: 'rts_static_balance_check' },
            { name: 'SEBT', input: 'rts_sebt_check' },
            { name: '垂直ジャンプ', input: 'rts_vertical_jump_check' },
            { name: 'ホップテスト', input: 'rts_hop_test_check' },
            { name: 'アジリティ', input: 'rts_agility_check' },
            { name: '自信', input: 'rts_confidence_check' },
            { name: '心理的準備', input: 'rts_mental_check' }
        ];

        let checkedCount = 0;
        let uncheckedItems = [];
        checkboxes.forEach(item => {
            const el = document.querySelector(`input[name="${item.input}"]`);
            if (el && el.checked) {
                checkedCount++;
            } else if (el) {
                uncheckedItems.push(item.name);
            }
        });

        const resultsDiv = document.getElementById('rtsPaassResults');
        const checkedDiv = document.getElementById('rtsPaassChecked');
        
        let html = `<p>達成項目: ${checkedCount} / ${checkboxes.length}</p>`;
        if (uncheckedItems.length > 0) {
            html += `<p style="color: red;">未達成項目: ${uncheckedItems.join(', ')}</p>`;
        } else {
            html += `<p style="color: green;">全ての項目を達成しました！</p>`;
        }
        checkedDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
    });
}


if (rtsEvalBtn && rtsPentagonCtx) {
  rtsEvalBtn.addEventListener('click', drawRtsPentagon);
}

// 五角形チャート描画関数
function drawRtsPentagon() {
  if (!rtsPentagonCtx) return;
  
  const canvas = rtsPentagonCanvas;
  const ctx = rtsPentagonCtx;
  const width = canvas.width;
  const height = canvas.height;
  const centerX = width / 2;
  const centerY = height / 2 + 10; // 少し下にずらして上部ラベルスペース確保
  const radius = Math.min(width, height) / 2 - 50; // ラベル用に余白を増やす
  
  ctx.clearRect(0, 0, width, height);
  
  const categories = [
    { name: '痛み', inputs: ['rts_pain_check'], weight: 1 }, // 1項目
    { name: '身体機能', inputs: ['rts_swelling_check', 'rts_wblt_check', 'rts_peroneal_check'], weight: 3 }, // 3項目
    { name: '感覚運動制御', inputs: ['rts_proprioception_check', 'rts_static_balance_check', 'rts_sebt_check'], weight: 3 }, // 3項目
    { name: 'スポーツパフォーマンス', inputs: ['rts_vertical_jump_check', 'rts_hop_test_check', 'rts_agility_check'], weight: 3 }, // 3項目
    { name: '心理的要因', inputs: ['rts_confidence_check', 'rts_mental_check'], weight: 2 } // 2項目
  ];
  
  const scores = []; // 0-10のスケール
  let totalWeightedScore = 0;
  let totalWeight = 0;
  
  categories.forEach(category => {
    let checkedCount = 0;
    category.inputs.forEach(inputName => {
      const input = document.querySelector(`input[name="${inputName}"]`);
      if (input && input.checked) {
        checkedCount++;
      }
    });
    const categoryScore = (checkedCount / category.inputs.length) * 10; // 0-10点満点
    scores.push(categoryScore);
    totalWeightedScore += categoryScore * category.weight;
    totalWeight += category.weight;
  });
  
  const overallScore = totalWeight > 0 ? totalWeightedScore / totalWeight : 0;

  let lowestCategory = { name: categories[0].name, score: scores[0] };
  scores.forEach((score, index) => {
      if (score < lowestCategory.score) {
          lowestCategory = { name: categories[index].name, score: score };
      }
  });

  drawPentagonGrid(ctx, centerX, centerY, radius, categories.map(c => c.name));
  drawPentagonData(ctx, centerX, centerY, radius, scores);
  displayRtsResults(overallScore, lowestCategory, scores, categories.map(c => c.name));
}

function drawPentagonGrid(ctx, centerX, centerY, radius, categoryNames) {
  const numSides = 5;
  const angleStep = (2 * Math.PI) / numSides;
  
  // 同心五角形 (レベル別)
  ctx.strokeStyle = '#cccccc';
  ctx.lineWidth = 0.5;
  for (let level = 1; level <= 5; level++) { // 2, 4, 6, 8, 10点
    const levelRadius = (radius * level) / 5;
    ctx.beginPath();
    for (let i = 0; i < numSides; i++) {
      const angle = i * angleStep - Math.PI / 2; // 上を頂点にする
      const x = centerX + levelRadius * Math.cos(angle);
      const y = centerY + levelRadius * Math.sin(angle);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.stroke();

    // レベルラベル (最初の軸、つまり一番上の軸に表示)
    if (level > 0) {
        ctx.fillStyle = '#999';
        ctx.font = '9px Arial';
        ctx.textAlign = 'center';
        const labelAngle = -Math.PI / 2; // 一番上の頂点
        const labelX = centerX + levelRadius * Math.cos(labelAngle) + 10; // 少し右にずらす
        const labelY = centerY + levelRadius * Math.sin(labelAngle);
        ctx.fillText((level * 2).toString(), labelX, labelY);
    }

  }
  
  // カテゴリ軸
  ctx.strokeStyle = '#999999';
  ctx.lineWidth = 1;
  for (let i = 0; i < numSides; i++) {
    const angle = i * angleStep - Math.PI / 2;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(centerX + radius * Math.cos(angle), centerY + radius * Math.sin(angle));
    ctx.stroke();
    
    // カテゴリラベル
    ctx.fillStyle = '#333';
    ctx.font = 'bold 11px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const labelRadius = radius + 15;
    const labelX = centerX + labelRadius * Math.cos(angle);
    const labelY = centerY + labelRadius * Math.sin(angle);
    // ラベルが長すぎる場合は改行処理などを検討
    ctx.fillText(categoryNames[i], labelX, labelY);
  }
}

function drawPentagonData(ctx, centerX, centerY, radius, scores) {
  const numSides = 5;
  const angleStep = (2 * Math.PI) / numSides;
  
  ctx.beginPath();
  scores.forEach((score, i) => {
    const pointRadius = (radius * score) / 10; // スコアは0-10点
    const angle = i * angleStep - Math.PI / 2;
    const x = centerX + pointRadius * Math.cos(angle);
    const y = centerY + pointRadius * Math.sin(angle);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.closePath();
  
  ctx.fillStyle = 'rgba(0, 120, 255, 0.4)';
  ctx.fill();
  ctx.strokeStyle = 'rgba(0, 80, 200, 0.9)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // データポイントとスコア値
  scores.forEach((score, i) => {
    const pointRadius = (radius * score) / 10;
    const angle = i * angleStep - Math.PI / 2;
    const x = centerX + pointRadius * Math.cos(angle);
    const y = centerY + pointRadius * Math.sin(angle);

    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0, 80, 200, 0.9)';
    ctx.fill();

    // スコアテキスト
    ctx.fillStyle = '#000';
    ctx.font = 'bold 10px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    // スコア表示位置の微調整
    const textRadius = pointRadius + 10; 
    const textX = centerX + textRadius * Math.cos(angle);
    const textY = centerY + textRadius * Math.sin(angle);
    ctx.fillText(score.toFixed(1), textX, textY);
  });
}


function displayRtsResults(overallScore, lowestCategory, scores, categoryNames) {
  const totalElement = document.getElementById('rtsTotal');
  const recommendationElement = document.getElementById('rtsRecommendation');
  const resultsContainer = document.getElementById('rtsResults');
  
  if (totalElement) {
    totalElement.innerHTML = `<strong>総合スコア: ${overallScore.toFixed(1)}/10</strong>`;
  }
  
  if (recommendationElement) {
    let recommendationText = '';
    let recommendationClass = 'recommendation';

    if (overallScore >= 8.5) { // 基準を少し厳しく
      recommendationText = 'スポーツへの完全復帰が可能な状態に近いと考えられます。';
      recommendationClass += ' good';
    } else if (overallScore >= 6.5) {
      recommendationText = '段階的な復帰を検討できます。特定の部分練習から開始し、徐々に負荷を上げてください。';
      recommendationClass += ' caution';
    } else {
      recommendationText = 'スポーツ復帰にはまだリスクが高いと考えられます。リハビリテーションの継続と、未達成項目の改善に注力してください。';
      recommendationClass += ' bad';
    }
    
    recommendationElement.innerHTML = `<div class="${recommendationClass}">${recommendationText}</div>`;
    
    if (lowestCategory && lowestCategory.score < 8.5) { // 8.5点未満の最低カテゴリを表示
         recommendationElement.innerHTML += `<p style="margin-top: 8px;">特に改善が推奨される項目: <strong>${lowestCategory.name}</strong> (スコア: ${lowestCategory.score.toFixed(1)})</p>`;
    }

    let categoryDetails = '<div style="margin-top: 10px;"><strong>カテゴリー別スコア:</strong><ul style="padding-left: 20px; margin-top: 5px; list-style-type: none;">';
    categoryNames.forEach((name, i) => {
      categoryDetails += `<li>${name}: ${scores[i].toFixed(1)} 点</li>`;
    });
    categoryDetails += '</ul></div>';
    recommendationElement.innerHTML += categoryDetails;
  }
  
  if(resultsContainer) resultsContainer.style.display = 'block';
}


// ----- 競技復帰評価（CAI機能テスト）関連 -----
// パネル表示制御
document.getElementById('showAlrRsiBtn').addEventListener('click', function() {
  const panel = document.getElementById('alrRsiPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  this.textContent = panel.style.display === 'none' ? 'ALR-RSI質問項目を表示' : 'ALR-RSI質問項目を閉じる';
});

document.getElementById('showFaamBtn').addEventListener('click', function() {
  const panel = document.getElementById('faamPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  this.textContent = panel.style.display === 'none' ? 'FAAM質問項目を表示' : 'FAAM質問項目を閉じる';
});

// ALR-RSIスライダーの値表示を更新
document.querySelectorAll('#alrRsiPanel .slider').forEach(slider => {
  const valueDisplay = slider.parentElement.querySelector('.slider-value');
  if (valueDisplay) {
      valueDisplay.textContent = slider.value; // 初期値を表示
      slider.addEventListener('input', function() {
          valueDisplay.textContent = this.value;
      });
  }
});


// ALR-RSI平均点計算
document.getElementById('calcAlrRsiBtn').addEventListener('click', function() {
  let sum = 0;
  const sliders = document.querySelectorAll('#alrRsiPanel .slider');
  sliders.forEach(slider => {
    sum += parseInt(slider.value);
  });
  
  const average = sliders.length > 0 ? sum / sliders.length : 0;
  const resultBox = document.getElementById('alrRsiResult');
  resultBox.style.display = 'block';
  
  const scoreElement = document.getElementById('alrRsiScore');
  scoreElement.textContent = `ALR-RSI平均点: ${average.toFixed(1)}点`;
  
  const evalElement = document.getElementById('alrRsiEvaluation');
  let radioToSelect;
  if (average >= 60) {
    evalElement.textContent = '心理的準備性: 良好（60点以上）';
    evalElement.className = 'recommendation good';
    radioToSelect = document.querySelector('input[name="cai_alr_rsi"][value="0"]');
  } else if (average >= 40) {
    evalElement.textContent = '心理的準備性: 注意（40-60点）';
    evalElement.className = 'recommendation caution';
    radioToSelect = document.querySelector('input[name="cai_alr_rsi"][value="1"]');
  } else {
    evalElement.textContent = '心理的準備性: 不十分（40点未満）';
    evalElement.className = 'recommendation bad';
    radioToSelect = document.querySelector('input[name="cai_alr_rsi"][value="5"]');
  }
  if (radioToSelect) radioToSelect.checked = true;
});

// FAAM得点計算
document.getElementById('calcFaamBtn').addEventListener('click', function() {
  let adlTotal = 0;
  let adlResponded = 0;
  const adlSelects = document.querySelectorAll('#faamPanel #faamAdl1, #faamPanel #faamAdl2, #faamPanel #faamAdl3, #faamPanel #faamAdl4, #faamPanel #faamAdl5'); // 5項目のみ
  adlSelects.forEach(select => {
      if (select.value !== 'na') {
          adlTotal += parseInt(select.value);
          adlResponded++;
      }
  });

  let sportTotal = 0;
  let sportResponded = 0;
  const sportSelects = document.querySelectorAll('#faamPanel #faamSport1, #faamPanel #faamSport2, #faamPanel #faamSport3, #faamPanel #faamSport4, #faamPanel #faamSport5'); // 5項目のみ
  sportSelects.forEach(select => {
      if (select.value !== 'na') {
          sportTotal += parseInt(select.value);
          sportResponded++;
      }
  });
  
  const adlMaxPossible = adlResponded * 4;
  const sportMaxPossible = sportResponded * 4;
  
  const adlPercentage = adlMaxPossible > 0 ? (adlTotal / adlMaxPossible) * 100 : 0;
  const sportPercentage = sportMaxPossible > 0 ? (sportTotal / sportMaxPossible) * 100 : 0;
  
  const resultBox = document.getElementById('faamResult');
  resultBox.style.display = 'block';
  
  document.getElementById('faamAdlScore').textContent = `ADLスコア: ${adlPercentage.toFixed(1)}% (回答数: ${adlResponded}/5)`;
  document.getElementById('faamSportScore').textContent = `スポーツスコア: ${sportPercentage.toFixed(1)}% (回答数: ${sportResponded}/5)`;
  
  const evalElement = document.getElementById('faamEvaluation');
  let adlRadio, sportRadio;

  if (adlPercentage >= 90) adlRadio = document.querySelector('input[name="cai_faam_adl"][value="0"]');
  else if (adlPercentage >= 80) adlRadio = document.querySelector('input[name="cai_faam_adl"][value="1"]');
  else adlRadio = document.querySelector('input[name="cai_faam_adl"][value="2"]');
  if(adlRadio) adlRadio.checked = true;
  
  if (sportPercentage >= 80) sportRadio = document.querySelector('input[name="cai_faam_sports"][value="0"]');
  else if (sportPercentage >= 60) sportRadio = document.querySelector('input[name="cai_faam_sports"][value="2"]');
  else sportRadio = document.querySelector('input[name="cai_faam_sports"][value="3"]');
  if(sportRadio) sportRadio.checked = true;
  
  if (adlPercentage >= 90 && sportPercentage >= 80) {
    evalElement.textContent = '足部・足関節機能: 良好';
    evalElement.className = 'recommendation good';
  } else if (adlPercentage >= 80 || sportPercentage >= 60) { //どちらかが基準を満たしていれば注意
    evalElement.textContent = '足部・足関節機能: 回復途上（一部注意）';
    evalElement.className = 'recommendation caution';
  } else {
    evalElement.textContent = '足部・足関節機能: 機能低下（要改善）';
    evalElement.className = 'recommendation bad';
  }
});

// CAI機能テスト総合評価
document.getElementById('caiEvalBtn').addEventListener('click', function() {
  const getRadioValue = (name) => {
    const radio = document.querySelector(`input[name="${name}"]:checked`);
    return radio ? parseInt(radio.value) : null;
  };
  
  const scoresMap = {
    sls: getRadioValue('cai_sls'),
    msebt: getRadioValue('cai_msebt'),
    sht: getRadioValue('cai_sht'),
    f8t: getRadioValue('cai_f8t'),
    alrRsi: getRadioValue('cai_alr_rsi'),
    faamAdl: getRadioValue('cai_faam_adl'),
    faamSports: getRadioValue('cai_faam_sports')
  };
  
  const scoresArray = Object.values(scoresMap);
  if (scoresArray.some(score => score === null)) {
    alert('CAI機能テストの全ての項目を評価または計算してください。');
    return;
  }
  
  const totalScore = scoresArray.reduce((sum, score) => sum + score, 0);
  const resultBox = document.getElementById('caiResults');
  resultBox.style.display = 'block';
  
  document.getElementById('caiTotal').textContent = `CAI機能テスト総合点: ${totalScore}/25点`;
  
  const evalElement = document.getElementById('caiEvaluation');
  if (totalScore < 8) {
    evalElement.textContent = '評価: 競技復帰可能の可能性が高い (8点未満)';
    evalElement.className = 'recommendation good';
  } else if (totalScore < 15) {
    evalElement.textContent = '評価: 復帰に注意が必要、追加のトレーニングや評価を推奨 (8-14点)';
    evalElement.className = 'recommendation caution';
  } else {
    evalElement.textContent = '評価: 競技復帰は非推奨、リハビリ継続が必要 (15点以上)';
    evalElement.className = 'recommendation bad';
  }
  
  document.getElementById('caiDetailScores').textContent = 
    `SLS: ${scoresMap.sls}点, mSEBT: ${scoresMap.msebt}点, SHT: ${scoresMap.sht}点, F8T: ${scoresMap.f8t}点, ALR-RSI: ${scoresMap.alrRsi}点, FAAM-ADL: ${scoresMap.faamAdl}点, FAAM-Sports: ${scoresMap.faamSports}点`;
});

// ローカルストレージに競技復帰評価データを保存する関数（呼び出しは適宜）
function saveCompetitionData() {
  // 既存のsaveAllDataに統合されているか、個別に保存したい場合に実装
}
// ローカルストレージから競技復帰評価データを読み込む関数（呼び出しはDOMContentLoadedなど）
function loadCompetitionData() {
  // 既存のloadAllDataに統合されているか、個別に読み込みたい場合に実装
}

// ALR-RSIスライダー値を保存する関数（呼び出しはスライダー変更時）
function saveAlrRsiSliders() {
  // 既存のsaveAllDataに統合されているか、個別に保存したい場合に実装
}


// すべてのタブの全データを保存する関数
function saveAllData() {
  try {
    const formElement = document.getElementById('evalForm');
    const formData = new FormData(formElement);
    const allFormData = {};
    
    for (const [key, value] of formData.entries()) {
      const element = formElement.elements[key];
      if (element) {
        if (element.type === 'checkbox') {
          // FormData はチェックされたチェックボックスしか含めないので、
          // 全てのチェックボックスの状態を別途取得する
          allFormData[key] = element.checked;
        } else if (element.type === 'radio') {
          // ラジオボタンはチェックされたものだけが FormData に入るので、
          // そのままで良いが、確実に保存するためにここで処理も可能
          if (element.checked) {
              allFormData[key] = value;
          }
        } else {
          allFormData[key] = value;
        }
      }
    }
    // チェックされていないチェックボックスの値をfalseとして追加
    const checkboxes = formElement.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
        if (!allFormData.hasOwnProperty(cb.name)) {
            allFormData[cb.name] = false;
        }
    });


    // ALR-RSIスライダー値 (競技復帰タブ内)
    const sliderData = {};
    document.querySelectorAll('#alrRsiPanel .slider').forEach(slider => {
        sliderData[slider.id] = slider.value;
    });

    // FAAM選択値 (競技復帰タブ内)
    const faamData = {};
    document.querySelectorAll('#faamPanel select').forEach(select => {
        faamData[select.id] = select.value;
    });
    
    // 画像マーキングデータ
    const markingDataToSave = {};
    for (let i = 1; i <= 4; i++) {
        if (markData[i]) {
            markingDataToSave[i] = markData[i];
        }
    }

    const completeData = {
      formData: allFormData, // Ottawa, 急性期, 亜急性期, スポーツ復帰のチェックボックスなど
      // 競技復帰タブのラジオボタンは formData に含まれる (name属性でグループ化されているため)
      alrRsiSliderData: sliderData,
      faamSelectData: faamData,
      markingData: markingDataToSave,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('ankleEvalData_latest', JSON.stringify(completeData)); // 最新のデータとして保存
    
    const confirmation = document.getElementById('saveConfirmation');
    confirmation.style.display = 'block';
    setTimeout(() => {
      confirmation.style.display = 'none';
    }, 3000);
    
    console.log('全データが正常に保存されました (latest)');
    saveHistoryData(completeData); // 履歴にも保存
    return true;
  } catch (error) {
    console.error('データ保存中にエラーが発生しました:', error);
    return false;
  }
}

// 保存した全データを読み込む関数
function loadAllData(dataToLoad) {
  try {
    const data = dataToLoad || JSON.parse(localStorage.getItem('ankleEvalData_latest'));
    if (!data) {
        console.log('読み込む保存データがありません。');
        return false;
    }
    
    const { formData, alrRsiSliderData, faamSelectData, markingData: loadedMarkingData } = data;
    const formElement = document.getElementById('evalForm');

    // フォームデータの復元 (チェックボックス、テキスト入力、選択されたラジオボタンなど)
    if (formData) {
      for (const [name, value] of Object.entries(formData)) {
        const elements = formElement.elements[name];
        if (elements) {
          if (elements.nodeName === 'INPUT' && elements.type === 'checkbox') {
            elements.checked = value;
          } else if (elements.nodeName === 'INPUT' && elements.type === 'radio') {
            // ラジオボタン群の場合
            const radioToSelect = formElement.querySelector(`input[name="${name}"][value="${value}"]`);
            if (radioToSelect) radioToSelect.checked = true;
          } else if (elements.length && elements[0].type === 'radio') { // RadioNodeList
            for (const radio of elements) {
              if (radio.value === value) {
                radio.checked = true;
                break;
              }
            }
          }
          else {
            elements.value = value;
            // WBLTタグなど、入力値に連動するUIの更新
            if (name === 'wblt') updateWBLTTag();
          }
        }
      }
    }
    
    // ALR-RSIスライダーの設定
    if (alrRsiSliderData) {
      for (const [id, value] of Object.entries(alrRsiSliderData)) {
        const slider = document.getElementById(id);
        if (slider) {
          slider.value = value;
          const valueDisplay = slider.parentElement.querySelector('.slider-value');
          if (valueDisplay) valueDisplay.textContent = value;
        }
      }
    }
    
    // FAAMセレクトボックスの設定
    if (faamSelectData) {
      for (const [id, value] of Object.entries(faamSelectData)) {
        const select = document.getElementById(id);
        if (select) select.value = value;
      }
    }
    
    // マーキングデータの復元
    if (loadedMarkingData) {
      for (let i = 1; i <= 4; i++) {
        if (loadedMarkingData[i]) {
          markData[i] = loadedMarkingData[i];
          if (canvases[i] && contexts[i]) { // キャンバスとコンテキストが存在するか確認
             updateCanvasSize(i); // サイズを再確認してから再描画
             redrawMarks(i);
          } else if (canvases[i]) { // コンテキストがない場合は、画像読み込み後に再描画されるようにする
            const img = canvases[i].previousElementSibling;
            if (img && img.complete) redrawMarks(i);
            else if (img) img.onload = () => { updateCanvasSize(i); redrawMarks(i); };
          }
        } else {
          markData[i] = []; // データがない場合は空にする
          if (canvases[i] && contexts[i]) redrawMarks(i); // クリア
        }
      }
    }
    
    console.log('全データをフォームに読み込みました');
    // 必要であれば、読み込み後に計算結果を再表示する処理をトリガー
    //例: if(document.querySelector('.tab.active[data-tab="competition"]')) { document.getElementById('caiEvalBtn').click(); }
    return true;
  } catch (error) {
    console.error('データ読み込み中にエラーが発生しました:', error);
    return false;
  }
}

// 履歴データを保存する関数
function saveHistoryData(currentData) {
  try {
    const historyString = localStorage.getItem('ankleEvalHistory');
    let historyData = historyString ? JSON.parse(historyString) : [];
    if (!Array.isArray(historyData)) historyData = []; // 安全策
    
    const newEntry = {
      id: `eval_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`, // よりユニークなID
      timestamp: currentData.timestamp || new Date().toISOString(), // currentDataにtimestampがなければ新規作成
      data: JSON.parse(JSON.stringify(currentData)) // ディープコピーして保存
    };
    
    historyData.unshift(newEntry);
    if (historyData.length > 20) historyData = historyData.slice(0, 20);
    
    localStorage.setItem('ankleEvalHistory', JSON.stringify(historyData));
    console.log('履歴データを保存しました:', newEntry.id);
    
    if (document.querySelector('.tab.active[data-tab="history"]')) {
      displayHistoryList();
    }
  } catch (error) {
    console.error('履歴データの保存中にエラーが発生しました:', error);
  }
}

// 履歴リストを表示する関数
function displayHistoryList() {
  const historyListElement = document.getElementById('historyList');
  if (!historyListElement) return;
  historyListElement.innerHTML = ''; 
  
  try {
    const historyData = JSON.parse(localStorage.getItem('ankleEvalHistory') || '[]');
    if (historyData.length === 0) {
      historyListElement.innerHTML = '<div class="empty-history-message">保存された評価データはありません。</div>';
      return;
    }
    
    const ul = document.createElement('ul');
    ul.style.listStyleType = 'none';
    ul.style.padding = '0';

    historyData.forEach(entry => {
      const li = document.createElement('li');
      li.style.border = '1px solid #ddd';
      li.style.marginBottom = '10px';
      li.style.padding = '10px';
      li.style.borderRadius = '5px';
      li.style.backgroundColor = '#f9f9f9';

      const date = new Date(entry.timestamp);
      const formattedDate = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      
      let summary = `評価日時: ${formattedDate}`;
      // 簡単なサマリー (例: Ottawaの陽性項目数)
      if (entry.data && entry.data.formData) {
          const ottawaFields = ['ottawa_lateral_malleolus', 'ottawa_medial_malleolus', 'ottawa_walk4', 'ottawa_navicular', 'ottawa_5thmeta'];
          let ottawaPositiveCount = 0;
          ottawaFields.forEach(field => {
              if (entry.data.formData[field] === true) ottawaPositiveCount++;
          });
          if (ottawaPositiveCount > 0) {
              summary += ` (Ottawa: ${ottawaPositiveCount}項目陽性)`;
          }
      }


      li.innerHTML = `
        <div style="font-weight: bold;">${summary}</div>
        <div style="margin-top: 8px;">
          <button class="view-details-btn" data-id="${entry.id}" style="padding: 5px 10px; margin-right: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">詳細表示</button>
          <button class="load-data-btn" data-id="${entry.id}" style="padding: 5px 10px; margin-right: 5px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">このデータを読込</button>
          <button class="delete-entry-btn" data-id="${entry.id}" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">削除</button>
        </div>
      `;
      ul.appendChild(li);
    });
    historyListElement.appendChild(ul);
    
    // イベントリスナー再設定
    addHistoryEventListeners();

  } catch (error) {
    console.error('履歴リストの表示中にエラー:', error);
    historyListElement.innerHTML = '<div class="error-message">履歴データの読み込みに失敗しました。</div>';
  }
}

function addHistoryEventListeners() {
    document.querySelectorAll('.view-details-btn').forEach(btn => {
      btn.addEventListener('click', function() { showHistoryDetails(this.dataset.id); });
    });
    document.querySelectorAll('.load-data-btn').forEach(btn => {
      btn.addEventListener('click', function() { loadHistoryEntry(this.dataset.id); });
    });
    document.querySelectorAll('.delete-entry-btn').forEach(btn => {
      btn.addEventListener('click', function() { deleteHistoryEntry(this.dataset.id); });
    });
}


// 履歴の詳細を表示する関数
function showHistoryDetails(id) {
  const historyDetailElement = document.getElementById('historyDetail');
  const historyDetailContent = document.getElementById('historyDetailContent');
  if (!historyDetailElement || !historyDetailContent) return;

  try {
    const historyData = JSON.parse(localStorage.getItem('ankleEvalHistory') || '[]');
    const entry = historyData.find(item => item.id === id);
    
    if (!entry || !entry.data) {
      historyDetailContent.innerHTML = '<p>指定された詳細データが見つかりません。</p>';
      historyDetailElement.style.display = 'block';
      return;
    }
    
    const date = new Date(entry.timestamp);
    const formattedDate = `${date.getFullYear()}年${(date.getMonth()+1)}月${date.getDate()}日 ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
    
    let detailsHTML = `<p><strong>評価日時:</strong> ${formattedDate}</p><hr>`;
    
    // 現場評価
    detailsHTML += "<h4>現場評価 (Ottawa Ankle Rules)</h4><ul>";
    const ottawaFields = {
        'ottawa_lateral_malleolus': '腓骨遠位・外果の痛み',
        'ottawa_medial_malleolus': '脛骨遠位・内果の痛み',
        'ottawa_walk4': '受傷直後4歩以上歩けない',
        'ottawa_navicular': '舟状骨の圧痛',
        'ottawa_5thmeta': '第5中足骨の圧痛'
    };
    let ottawaPositive = false;
    for (const key in ottawaFields) {
        if (entry.data.formData && entry.data.formData[key]) {
            detailsHTML += `<li>${ottawaFields[key]}: <span style="color:red;">陽性</span></li>`;
            ottawaPositive = true;
        } else if (entry.data.formData && entry.data.formData.hasOwnProperty(key)) {
             detailsHTML += `<li>${ottawaFields[key]}: 陰性</li>`;
        }
    }
    if (!ottawaPositive && entry.data.formData) detailsHTML += "<li>全ての項目が陰性でした。</li>";
    else if (!entry.data.formData) detailsHTML += "<li>データなし</li>";
    detailsHTML += "</ul>";

    // スポーツ復帰評価 (チェック項目)
    detailsHTML += "<h4>スポーツ復帰評価 (チェック項目)</h4><ul>";
    const rtsFields = {
        'rts_pain_check': '痛みがない/減少', 'rts_swelling_check': '腫脹なし',
        'rts_wblt_check': 'WBLT左右差なし', 'rts_peroneal_check': '腓骨筋筋力左右差なし',
        'rts_proprioception_check': '固有受容感覚正常', 'rts_static_balance_check': '静的バランス正常',
        'rts_sebt_check': 'SEBT健側80%以上', 'rts_vertical_jump_check': '垂直ジャンプ健側90%以上',
        'rts_hop_test_check': 'ホップテスト健側80%以上', 'rts_agility_check': 'アジリティ年齢相応',
        'rts_confidence_check': '足関節への自信', 'rts_mental_check': '復帰への心理的準備'
    };
    let rtsChecked = 0;
    if (entry.data.formData) {
        for (const key in rtsFields) {
            if (entry.data.formData[key]) {
                detailsHTML += `<li>${rtsFields[key]}: <span style="color:green;">達成</span></li>`;
                rtsChecked++;
            } else if (entry.data.formData.hasOwnProperty(key)) {
                detailsHTML += `<li>${rtsFields[key]}: 未達成</li>`;
            }
        }
        detailsHTML += `<li><strong>達成項目数: ${rtsChecked} / ${Object.keys(rtsFields).length}</strong></li>`;
    } else {
         detailsHTML += "<li>データなし</li>";
    }
    detailsHTML += "</ul>";


    // CAI機能テスト (競技復帰評価)
    detailsHTML += "<h4>競技復帰評価 (CAI機能テスト)</h4>";
    if (entry.data.formData && entry.data.formData['cai_sls'] !== undefined) { // cai_slsの存在で判定
        const caiNames = {
            'cai_sls': 'SLS', 'cai_msebt': 'mSEBT', 'cai_sht': 'SHT', 'cai_f8t': 'F8T',
            'cai_alr_rsi': 'ALR-RSI', 'cai_faam_adl': 'FAAM ADL', 'cai_faam_sports': 'FAAM Sports'
        };
        let caiTotalScore = 0;
        detailsHTML += "<ul>";
        for(const key in caiNames) {
            const score = parseInt(entry.data.formData[key]);
            if (!isNaN(score)) {
                detailsHTML += `<li>${caiNames[key]}: ${score}点</li>`;
                caiTotalScore += score;
            } else {
                detailsHTML += `<li>${caiNames[key]}: - 点</li>`;
            }
        }
        detailsHTML += `<li><strong>CAI総合点: ${caiTotalScore} / 25点</strong></li>`;
        detailsHTML += "</ul>";
    } else {
        detailsHTML += "<p>データなし</p>";
    }

    historyDetailContent.innerHTML = detailsHTML;
    historyDetailElement.style.display = 'block';
    historyDetailElement.scrollIntoView({ behavior: 'smooth' });
    
  } catch (error) {
    console.error('履歴詳細の表示中にエラーが発生しました:', error);
    historyDetailContent.innerHTML = '<p>データの読み込み中にエラーが発生しました。</p>';
    historyDetailElement.style.display = 'block';
  }
}

// 履歴データを読み込む関数
function loadHistoryEntry(id) {
  try {
    const historyData = JSON.parse(localStorage.getItem('ankleEvalHistory') || '[]');
    const entry = historyData.find(item => item.id === id);
    
    if (!entry || !entry.data) {
      alert('指定された履歴データが見つかりません。');
      return;
    }
    
    if (confirm('この履歴データを現在のフォームに読み込みますか？\n（現在の入力内容は上書きされます）')) {
        loadAllData(entry.data); // entry.data を渡して読み込み
        alert('データを読み込みました。各タブを確認してください。');
        // 必要に応じて、最初のタブに切り替えるなど
        document.querySelector('.tab[data-tab="field"]').click();
    }
    
  } catch (error) {
    console.error('履歴データの読み込み中にエラーが発生しました:', error);
    alert('データの読み込み中にエラーが発生しました。');
  }
}

// 履歴エントリーを削除する関数
function deleteHistoryEntry(id) {
  if (!confirm('この履歴データを削除してもよろしいですか？')) return;
  
  try {
    let historyData = JSON.parse(localStorage.getItem('ankleEvalHistory') || '[]');
    historyData = historyData.filter(item => item.id !== id);
    localStorage.setItem('ankleEvalHistory', JSON.stringify(historyData));
    
    displayHistoryList(); // リストを更新
    document.getElementById('historyDetail').style.display = 'none'; // 詳細表示を隠す
    alert('データを削除しました。');
  } catch (error) {
    console.error('履歴エントリーの削除中にエラー:', error);
    alert('データの削除中にエラーが発生しました。');
  }
}

// すべての履歴を削除する関数
function clearAllHistory() {
  if (!confirm('本当にすべての履歴データを削除してもよろしいですか？\nこの操作は元に戻せません。')) return;
  
  try {
    localStorage.removeItem('ankleEvalHistory');
    displayHistoryList();
    document.getElementById('historyDetail').style.display = 'none';
    alert('すべての履歴データが削除されました。');
  } catch (error) {
    console.error('履歴データの一括削除中にエラー:', error);
    alert('データの削除中にエラーが発生しました。');
  }
}

// ページ初期化時の処理
document.addEventListener('DOMContentLoaded', function() {
  loadAllData(); // 最新のデータを読み込む
  
  // 履歴タブ関連のボタンにイベントリスナーを設定
  const refreshBtn = document.getElementById('refreshHistoryBtn');
  if (refreshBtn) refreshBtn.addEventListener('click', displayHistoryList);
  
  const clearBtn = document.getElementById('clearHistoryBtn');
  if (clearBtn) clearBtn.addEventListener('click', clearAllHistory);

  // 最初のタブが履歴タブだった場合のためにリスト表示
  if (document.querySelector('.tab.active[data-tab="history"]')) {
      displayHistoryList();
  }

  // ALR-RSIスライダーなどの動的UIの初期化（もしあれば）
});

// フォーム送信時にデータを保存
document.getElementById('evalForm').addEventListener('submit', function(e) {
  e.preventDefault(); 
  if(saveAllData()){
      // 保存成功時の追加処理（例：メッセージ表示など）はsaveAllData内で行われる
  } else {
      alert('データの保存に失敗しました。');
  }
});
</script>
</body>
</html>
```
Start typing a prompt
